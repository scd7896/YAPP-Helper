# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Node.js CI

on:
  push:
    branches: [master, feature/cicd-test]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: SSH and deploy node app
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
        script: |
          cd ~/YAPP-Helper
          sudo systemctl stop apache2
          sudo pm2 kill
          git pull origin master
          npm install
          npm run migrate
          npm run prod
          sudo pm2 start ecosystem.config.js
          sudo syatemctl start apache2
